#!/bin/sh

export BUILD_DIR=$1
bp_dir=$(cd $(dirname $0); cd ..; pwd)

if [ ! -f "$BUILD_DIR/.gitmodules" ]; then
  echo "---> No .gitmodules file found. Skipping."
  exit 0
fi

export GEM_HOME=$bp_dir/vendor/gems
export GEM_PATH=$bp_dir/vendor/gems

env_dir=$1
whitelist_regex=${2:-'BUILDPACK_BRANCH'}
blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
if [ -d "$env_dir" ]; then
  for e in $(ls $env_dir); do
    echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
    export "$e=$(cat $env_dir/$e)"
    :
  done
fi

echo "---> Installing parseconfig gem"
gem install 'parseconfig'

ruby $bp_dir/bin/install_git_submodules.rb
